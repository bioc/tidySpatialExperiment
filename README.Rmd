---
title: "tidySpatialExperiment - part of tidytranscriptomics"
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

**Brings SpatialExperiment to the Tidyverse** 

<!-- badges: start -->
[![Lifecycle:experimental](https://img.shields.io/badge/lifecycle-experimental-blue.svg)](https://www.tidyverse.org/lifecycle/#experimental) [![R build status](https://github.com/william-hutchison/tidySpatialExperiment/actions/workflows/check-bioc.yml/badge.svg)](https://github.com/william-hutchison/tidySpatialExperiment/actions)
<!-- badges: end -->

You can find more packages from the tidytranscriptomics ecosystem here:

- [tidySingleCellExperiment](https://github.com/stemangiola/tidySingleCellExperiment) for tidy manipulation of SingleCellExperiment objects
- [tidySummarizedExperiment](https://github.com/stemangiola/tidySummarizedExperiment) for tidy manipulation of SummarizedExperiment objects
- [tidyseurat](https://github.com/stemangiola/tidyseurat) for tidy manipulation of Seurat objects
- [tidybulk](https://github.com/stemangiola/tidybulk) for tidy bulk RNA-seq data analysis
- [nanny](https://github.com/stemangiola/nanny) for tidy high-level data analysis and manipulation 
- [tidygate](https://github.com/stemangiola/tidygate) for adding custom gate information to your tibble 
- [tidyHeatmap](https://github.com/stemangiola/tidyHeatmap) for heatmaps produced with tidy principles

# Introduction

tidySpatialExperiment provides a bridge between the [SpatialExperiment](https://github.com/drighelli/SpatialExperiment) [@righelli2022spatialexperiment] and [Tidyverse](https://www.tidyverse.org) [@wickham2019welcome] packages. It creates an invisible layer that allows you to interact with a SpatialExperiment object as if it were a tibble: allowing the use of *dplyr*, *tidyr*, *ggplot2* and *plotly* functions. But, underneath, your data remains a SpatialExperiment object.

tidySpatialExperiment also provides three additional utility functions.

## Functions and utilities

Package | Functions available
------------ | -------------
`SpatialExperiment` | All
`dplyr` | `arrange`,`bind_rows`, `bind_cols`, `distinct`, `filter`, `group_by`, `summarise`,  `select`, `mutate`, `rename`, `left_join`, `right_join`, `inner_join`, `slice`, `sample_n`, `sample_frac`, `count`, `add_count`
`tidyr` | `nest`, `unnest`, `unite`, `separate`, `extract`, `pivot_longer`
`ggplot2` | `ggplot`
`plotly` | `plot_ly`

Utility | Description
------------ | -------------
`as_tibble` | Convert cell-wise information to a `tbl_df`
`join_features` | Combine cell-wise and feature-wise information into a `tbl_df`
`aggregate_cells` | Aggregate cell feature abundance into a pseudobulk `SummarizedExperiment`

## SpatialExperiment-tibble abstraction

A SpatialExperiment object represents cells as columns and features as rows, as is the Bioconductor convention. Additional information about the cells is accessed through the `reducedDims`, `colData` and `spatialCoords` functions. 

tidySpatialExperiment provides a SpatialExperiment-tibble abstraction, representing cells (observations) as rows and features (variables) as columns, as is the Tidyverse convention. In addition, `colData` and `spatialCoords` are appended as columns to the same abstraction, allowing easy interaction with this additional data. 

## Installation

You can install the development version of tidySpatialExperiment from GitHub with:

```
install.packages("devtools")
devtools::install_github("william-hutchison/tidySpatialExperiment")
```

# Examples
## Load data

Here, we load and view an example SpatialExperiment object. The output we see is of the SpatialExperiment-tibble abstraction.

```{r, message=FALSE, results=FALSE}
# Load example SpatialExperiment object
library(tidySpatialExperiment)
example(read10xVisium)
```

```{r}
# View the SpatialExperiment-tibble abstraction
spe
```

However, our object is still a SpatialExperiment object. Therefore, we have access to all SpatialExperiment functions. 

```{r}
spe |>
  colData() |>
  head()

spe |> 
  spatialCoords() |>
  head()

spe |>
  imgData()
```

## Manipulate with dplyr

Most functions from *dplyr* are available for use with the SpatialExperiment-tibble abstraction. For example, `filter` can be used to select cells by a variable of interest. 

```{r}
spe |>
  filter(array_col < 5)

```

And `mutate` can be used to add new variables, or modify the value of an existing variable.
```{r}
spe |>
  mutate(in_region = c(in_tissue & array_row < 10))
```

## Tidy with tidyr

Most functions from *tidyr* are also available. Here, `nest` is used to group the data by sample_id, and `unnest` is used to ungroup the data.

```{r}
# Nest the SpatialExperiment object by sample_id
spe_nested <-
  spe |> 
  nest(data = -sample_id)

# View the nested SpatialExperiment object
spe_nested

# Unnest the nested SpatialExperiment objects
spe_nested |>
  unnest(data)
```

## Plot with ggplot2

The `ggplot` function can be used to create a plot from a SpatialExperiment object. This example also demonstrates how tidy operations can be combined to build up more complex analysis. It should be noted that helper functions such `aes` are not included and should be imported from *ggplot2*. 

```{r}
spe |>
  filter(sample_id == "section1" & in_tissue) |>
  
  # Add a column with the sum of feature counts per cell
  mutate(count_sum = purrr::map_int(.cell, ~
    spe[, .x] |> 
      counts() |> 
      sum()
    )) |>
  
  # Plot with tidySpatialExperiment and ggplot2
  ggplot(ggplot2::aes(x = reorder(.cell, count_sum), y = count_sum)) +
  ggplot2::geom_point() +
  ggplot2::coord_flip()
```

## Plot with plotly
The `plot_ly` function can also be used to create a plot from a SpatialExperiment object.

```{r, fig.keep="first", message=FALSE, warning=FALSE}
spe |>
  filter(sample_id == "section1") |>
  plot_ly(
    x = ~ array_row, 
    y = ~ array_col, 
    color = ~ in_tissue, 
    type = "scatter"
  )
```

# Important considerations

tidySpatialExperiment is still in development and contains some rough edges. Below are examples of behaviour that is currently unclear. I will be adding warning messages / making changes to address these problems in the coming weeks.

## Read-only columns

Removing the .cell column will return a tibble. This is consistent with the behaviour in other tidytranscriptomics packages.
```{r}
spe |>
  select(-.cell) |>
  head()
```

The sample_id column cannot be removed with tidyverse functions, and can only be modified if the changes are accepted by SpatialExperiment's `colData` function.
```{r, error=TRUE}
# sample_id is not removed, despite the user's request
spe |>
  select(-sample_id)

# This change maintains separation of sample_ids and is permitted
spe |> 
  mutate(sample_id = stringr::str_c(sample_id, "_modified")) |>
  head()

# This change does not maintain separation of sample_ids and produces an error
spe |>
  mutate(sample_id = "new_sample")
```

The pxl_col_in_fullres and px_row_in_fullres columns cannot be removed or modified with tidyverse functions. This is consistent with the behaviour of dimension reduction data in other tidytranscriptomics packages.

```{r, error=TRUE}
# Attempting to remove pxl_col_in_fullres produces an error
spe |>
  select(-pxl_col_in_fullres)

# Attempting to modify pxl_col_in_fullres produces an error
spe |> 
  mutate(pxl_col_in_fullres)
```

