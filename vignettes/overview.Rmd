---
title: "Overview of tidySpatialExperiment"
author:
- name: William Hutchison
  affiliation: WEHI - Walter and Eliza Hall Institute of Medical Research
  email: hutchison.w@wehi.edu.au
- name: Stefano Mangiola
  affiliation: WEHI - Walter and Eliza Hall Institute of Medical Research
package: tidySpatialExperiment
output:
  BiocStyle::html_document
abstract: |
  A bried overview of tidySpatialExperiment
vignette: |
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

tidySpatialExperiment provides a bridge between the [SpatialExperiment](https://github.com/drighelli/SpatialExperiment) [@righelli2022spatialexperiment] and [Tidyverse](https://www.tidyverse.org) [@wickham2019welcome] packages. It creates an invisible layer that allows you to interact with a SpatialExperiment object as if it were a tibble: allowing the use of *dplyr*, *tidyr*, *ggplot2* and *plotly* functions. But, underneath, your data remains a SpatialExperiment object.

tidySpatialExperiment also provides two additional utility functions.

## Functions and utilities

Package | Functions available
------------ | -------------
`SpatialExperiment` | All
`dplyr` | `arrange`,`bind_rows`, `bind_cols`, `distinct`, `filter`, `group_by`, `summarise`,  `select`, `mutate`, `rename`, `left_join`, `right_join`, `inner_join`, `slice`, `sample_n`, `sample_frac`, `count`, `add_count`
`tidyr` | `nest`, `unnest`, `unite`, `separate`, `extract`, `pivot_longer`
`ggplot2` | `ggplot`
`plotly` | `plot_ly`

Utility | Description
------------ | -------------
`as_tibble` | Convert cell-wise information to a `tbl_df`
`aggregate_cells` | Aggregate cell gene-transcription abundance as pseudobulk tissue

## SpatialExperiment-tibble abstraction

A SpatialExperiment object represents cells as columns and features as rows, as is the Bioconductor convention. Additional information about the cells is accessed through the `reducedDims`, `colData` and `spatialCoords` functions. 

tidySpatialExperiment provides a SpatialExperiment-tibble abstraction, representing cells (observations) as rows and features (variables) as columns, as is the Tidyverse convention. In addition, `colData` and `spatialCoords` are appended as columns to the same abstraction, allowing easy interaction with this additional data. 

## Installation

You can install the development version of tidySpatialExperiment from GitHub with:

```
install.packages("devtools")
devtools::install_github("william-hutchison/tidySpatialExperiment")
```

# Examples
## Load data

Here, we load and view an example SpatialExperiment object. The output we see is of the SpatialExperiment-tibble abstraction.

```{r, message=FALSE, results=FALSE}
# Load example SpatialExperiment object
library(tidySpatialExperiment)
example(read10xVisium)
```

```{r}
# View the SpatialExperiment-tibble abstraction
spe
```

However, our object is still a SpatialExperiment object. Therefore, we have access to all SpatialExperiment functions. 

```{r}
spe |>
  colData() |>
  head()

spe |> 
  spatialCoords() |>
  head()

spe |>
  imgData()
```

## Manipulate with dplyr
Most functions from *dplyr* are available for use with the SpatialExperiment-tibble abstraction. For example, `filter` can be used to select cells by a variable of interest. 

```{r}
spe |>
  filter(array_col < 5)

```

And `mutate` can be used to add new variables, or modify the value of an existing variable.
```{r}
spe |>
  mutate(in_region = c(in_tissue & array_row < 10))
```

## Tidy with tidyr

Most functions from *tidyr* are also available. Here, `nest` is used to group the data by sample_id, and `unnest` is used to ungroup the data.

```{r}
# Nest the SpatialExperiment object by sample_id
spe_nested <-
  spe |> 
  nest(data = -sample_id)

# View the nested SpatialExperiment object
spe_nested

# Unnest the nested SpatialExperiment objects
spe_nested |>
  unnest(data)
```

## Plot with ggplot2

The `ggplot` function can be used to create a plot from a SpatialExperiment object. This example also demonstrates how tidy operations can be combined to build up more complex analysis. It should be noted that helper functions such `aes` are not included and should be imported from *ggplot2*. 

```{r}
spe |>
  filter(sample_id == "section1") |>
  
  # Add a column with the sum of feature counts per cell
  mutate(count_sum = purrr::map_int(.cell, ~
    spe[, .x] |> 
      counts() |> 
      sum()
    )) |>
  
  # Plot with tidySpatialExperiment and ggplot2
  ggplot(ggplot2::aes(x = reorder(.cell, count_sum), y = count_sum)) +
  ggplot2::geom_point() +
  ggplot2::coord_flip()
```

## Plot with plotly
The `plot_ly` function can also be used to create a plot from a SpatialExperiment object.

```{r, fig.keep="first"}
spe |>
  filter(sample_id == "section1") |>
  plot_ly(
    x = ~ array_row, 
    y = ~ array_col, 
    color = ~ in_tissue, 
    type = "scatter"
  )
```

# Session info
```{r sessionInfo, echo=FALSE}
sessionInfo()
```

